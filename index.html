<script>
//â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•
// script.js
//â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•

// æ›œæ—¥ãƒ©ãƒ™ãƒ«ï¼ˆé€±ã®é–‹å§‹ã¯æœˆæ›œæ—¥ï¼‰
const WEEKDAYS = ["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥"];

// è¨ºç™‚ç§‘ã®è¡¨ç¤ºé †ï¼ˆé™¢ã”ã¨ã«å‡ºã¦ãã‚‹é †ç•ªã®å„ªå…ˆãƒªã‚¹ãƒˆï¼‰
const DEPT_ORDER = [
  "å°å…ç§‘ï¼‘è¨º",
  "å°å…ç§‘ï¼’è¨º",
  "å°å…ç§‘ï¼“è¨º",
  "è€³é¼»ç§‘ï¼‘è¨º",
  "è€³é¼»ç§‘ï¼’è¨º",
  "è€³é¼»ç§‘ï¼“è¨º",
  "çš®è†šç§‘",
  "å½¢æˆå¤–ç§‘",
  "å°å…ç§‘å¤œè¨º",
  "è€³é¼»ç§‘å¤œè¨º"
];

// ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹æœ€å°ãƒ»æœ€å¤§å¹´æœˆï¼ˆ"YYYY-MM"å½¢å¼ã€æœˆåˆ‡æ›¿ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹ãƒ»ç„¡åŠ¹åˆ¤å®šã§åˆ©ç”¨ï¼‰
let minYearMonth = "";
let maxYearMonth = "";


/**************************************************************************************
 * ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å—ã‘å–ã‚Šã€
 * ãã®ã€Œåå¯¾ã®æœˆã ã‘ã€ã®ã‚¿ãƒ–ã‚’ä¸Šä¸‹ï¼’ã¤ã«ç”Ÿæˆã™ã‚‹
 * @param {number} currentOffset - 0=å½“æœˆã€1=ç¿Œæœˆ
 *
 * â€»ã‚¿ãƒ–UIã§ã€Œä»Šè¡¨ç¤ºã—ã¦ã„ãªã„æ–¹ã®æœˆã€ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡ã‚Šæ›¿ãˆã‚‹
 **************************************************************************************/
function createMonthTab(currentOffset = 0) {
  // .tab-containerã‚¯ãƒ©ã‚¹ã®å…¨ã¦ã®è¦ç´ ã‚’å–å¾—ï¼ˆã‚¿ãƒ–è¡¨ç¤ºç”¨ï¼‰
  const containers = document.querySelectorAll('.tab-container');
  if (containers.length === 0) return;

  // ç¾åœ¨æ—¥æ™‚ã‹ã‚‰ä»Šå¹´ãƒ»ä»Šæœˆã‚’å–å¾—
  const now      = new Date();
  const y0       = now.getFullYear(), m0 = now.getMonth();           // å½“æœˆ
  const nextDate = new Date(y0, m0 + 1, 1);                          // ç¿Œæœˆã®1æ—¥
  const y1       = nextDate.getFullYear(), m1 = nextDate.getMonth(); // ç¿Œæœˆ

  // æ¬¡ã«è¡¨ç¤ºã™ã‚‹ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’æ±ºå®šï¼ˆ0:ä»Šæœˆâ†’1:æ¥æœˆ, 1:æ¥æœˆâ†’0:ä»Šæœˆï¼‰
  const nextOffset = currentOffset === 0 ? 1 : 0;
  // ã‚¿ãƒ–ã«è¡¨ç¤ºã™ã‚‹å¹´æœˆãƒ©ãƒ™ãƒ«ã‚’ä½œæˆ
  const label = nextOffset === 0
    ? `${y0}å¹´${m0 + 1}æœˆ`
    : `${y1}å¹´${m1 + 1}æœˆ`;

  containers.forEach(container => {
    // ã¾ãšã‚³ãƒ³ãƒ†ãƒŠå†…ã®æ—¢å­˜è¦ç´ ã‚’ã‚¯ãƒªã‚¢
    container.innerHTML = '';
    // æ–°ã—ã„ã‚¿ãƒ–è¦ç´ ã‚’ä½œæˆ
    const tab = document.createElement('div');
    tab.className      = 'tab';               // ã‚¿ãƒ–ç”¨ã‚¯ãƒ©ã‚¹
    tab.dataset.offset = nextOffset;          // ã©ã¡ã‚‰ã®æœˆã‹ï¼ˆ0/1ï¼‰ã‚’å±æ€§ã§æŒã¤
    tab.textContent   = label;                // ã‚¿ãƒ–ã«å¹´æœˆã‚’è¡¨ç¤º
    tab.addEventListener('click', () => {
      // ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼šã‚‚ã†ç‰‡æ–¹ã®æœˆã®ã‚¿ãƒ–ã‚’å†æç”»ã—ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚å–å¾—
      createMonthTab(nextOffset);
      fetchSchedule(nextOffset);
    });
    // ä½œæˆã—ãŸã‚¿ãƒ–ã‚’DOMã«è¿½åŠ 
    container.appendChild(tab);
  });
}




/**************************************************************************************
 * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 * @param {number} monthOffset - 0=å½“æœˆã€1=ç¿Œæœˆ, ...ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã®åŸºæº–æœˆã‚’ãšã‚‰ã™å€¤ï¼‰
 **************************************************************************************/
function renderCalendar(monthOffset = 0) {
  // 1) è¡¨ç¤ºæœˆã®åŸºæœ¬æƒ…å ±
  const { year, month, firstWeekday, totalDays, numWeeks } = calcMonthInfo(monthOffset);

  // 2) ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–° & ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–
  updateTitle(year, month);
  clearTable();
  renderHeader();

  // 3) ç¥æ—¥ã‚’åˆ¤å®šã—ã‚„ã™ã„å½¢ã«
  const holidaySet = new Set(
    Array.isArray(holidays) ? holidays.map(h => h.split('(')[0]) : []
  );

  const tbody = document.querySelector('#calendar tbody');

  // é€±ã”ã¨ã«æç”»
  for (let w = 0; w < numWeeks; w++) {
    // (a) æ—¥ä»˜è¡Œ
    const trWeek = document.createElement('tr');
    trWeek.classList.add('week-row', 'date-row');

    const tdLabel = document.createElement('td');
    tdLabel.textContent = '';
    trWeek.appendChild(tdLabel);

    for (let d = 0; d < 7; d++) {
      const td = document.createElement('td');
      const dayNum = w * 7 + d - firstWeekday + 1;

      if (dayNum >= 1 && dayNum <= totalDays) {
        const label = `${month + 1}/${dayNum}`;
        td.textContent = dayNum;

        // åœŸæ—¥
        if (d === 5) td.classList.add('saturday');
        if (d === 6) td.classList.add('sunday');

        // ç¥æ—¥
        if (holidaySet.has(label)) td.classList.add('holiday');

        // ä»Šæ—¥
        const today = new Date();
        if (
          year === today.getFullYear() &&
          month === today.getMonth() &&
          dayNum === today.getDate()
        ) {
          td.classList.add('today-cell');
        }
      }
      trWeek.appendChild(td);
    }
    tbody.appendChild(trWeek);

    // (b) ãã®é€±ã®ã€Œå„æ—¥ä»˜ã«å°‘ãªãã¨ã‚‚1è¨ºç™‚ç§‘ã§ã‚‚åŒ»å¸«ãŒå…¥ã£ã¦ã„ã‚‹ã‹ã€ã‚’å…ˆã«åˆ¤å®š
    const dayHasDoctor = {};
    for (let d = 0; d < 7; d++) {
      const dayNum = w * 7 + d - firstWeekday + 1;
      if (dayNum < 1 || dayNum > totalDays) continue;
      const key = `${month + 1}/${dayNum}(${WEEKDAYS[d]})`;
      dayHasDoctor[dayNum] = rooms.some(room => {
        const entry = schedule[room]?.[key];
        const disp = entry?.displayName || entry?.name || '';
        // ã€Œä¼‘è¨ºã€ä»¥å¤–ãŒå…¥ã£ã¦ã„ã‚Œã°â€œåŒ»å¸«ã‚ã‚Šâ€
        return !!disp && disp !== 'ä¼‘è¨º';
      });
    }

    // (c) å„è¨ºç™‚ç§‘ã®è¡Œ
//    rooms.forEach(room => {
    rooms.forEach((room, rIndex) => {
      const trRoom = document.createElement('tr');

      const tdRoom = document.createElement('td');
      tdRoom.textContent = room;
      trRoom.appendChild(tdRoom);

      for (let d = 0; d < 7; d++) {
        const td = document.createElement('td');
        const dayNum = w * 7 + d - firstWeekday + 1;

        if (dayNum >= 1 && dayNum <= totalDays) {
          const key = `${month + 1}/${dayNum}(${WEEKDAYS[d]})`;
          const entry = schedule[room]?.[key];

          // â˜… ãã®æ—¥ã¾ã‚‹ã”ã¨ä¼‘è¨ºãªã‚‰ã€æœ€åˆã®è¨ºç™‚ç§‘è¡Œã«ã ã‘ã€Œä¼‘è¨ºæ—¥ï¼ˆrowSpanï¼‰ã€ã‚’ç«‹ã¦ã‚‹
          if (!dayHasDoctor[dayNum]) {
            if (rIndex === 0) {
              td.textContent = "ä¼‘è¨ºæ—¥";
              td.classList.add("kyushin-cell");
              td.style.cursor = "";
              td.setAttribute("aria-label", `${month + 1}/${dayNum} ä¼‘è¨ºæ—¥`);
              td.rowSpan = rooms.length;     // â† ç¸¦çµåˆï¼
              trRoom.appendChild(td);
            }
            // rIndex>0 ã®è¡Œã¯ã€ã“ã®æ—¥ã® <td> ã¯è¿½åŠ ã—ãªã„ï¼ˆä¸Šã® rowSpan ã«å¸åã•ã‚Œã‚‹ï¼‰
            continue; // â† æ¬¡ã®æ—¥ã¸
          }

          if (entry && (entry.name || entry.displayName)) {
            // è¡¨ç¤ºå†…å®¹
            td.innerHTML =
              `<div><span>${entry.timeFrom || ""}${entry.timeTo ? 'ï½' + entry.timeTo : ''}</span></div>
               <div><span${entry.sex === "å¥³" ? ' class="female"' : ''}>${entry.displayName || entry.name}</span>${entry.tongueMark ? ` <span title="èˆŒä¸‹">${entry.tongueMark}</span>` : ''}</div>`;

            // ä¼‘è¨º/èª¿æ•´ä¸­ã®ã‚¯ãƒ©ã‚¹
            if (entry.displayName === "ä¼‘è¨º") {
              td.classList.add("kyushin-cell");
              td.style.cursor = "";
            } else {
              td.style.cursor = "zoom-in";
              td.addEventListener('click', () => {
                showCellModal({
                  date: `${month + 1}/${dayNum}`,
                  dept: room,
                  time: `${entry.timeFrom || ""}${entry.timeTo ? 'ï½' + entry.timeTo : ''}`,
                  name: entry.displayName || entry.name,
                  tongue: entry.tongueMark
                });
              });
            }
            if (entry.displayName === "èª¿æ•´ä¸­") {
              td.classList.add("cyousei-cell");
            }
          } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„ã‚»ãƒ«ï¼šãã®æ—¥å…¨ä½“ã«åŒ»å¸«ãŒã„ã‚‹ã‹ã§è¡¨ç¤ºã‚’åˆ†å²
            if (dayHasDoctor[dayNum]) {
              td.textContent = "âˆ’";       // ãƒã‚¤ãƒ•ãƒ³ã€éã‚°ãƒ¬ãƒ¼
              td.style.cursor = "";
            } else {
              td.textContent = "ä¼‘è¨º";    // ãã®æ—¥ã¾ã‚‹ã”ã¨ä¼‘è¨º â†’ ã‚°ãƒ¬ãƒ¼
              td.classList.add("kyushin-cell");
              td.style.cursor = "";
            }
            td.setAttribute("aria-label", `${month + 1}/${dayNum} ${room} ${td.textContent}`);
          }
        }

        trRoom.appendChild(td);
      }

      tbody.appendChild(trRoom);
    });
  }
}


/**************************************************************************************
 * æŒ‡å®šã—ãŸæœˆã‚ªãƒ•ã‚»ãƒƒãƒˆã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŸºæœ¬æƒ…å ±ã‚’è¿”ã™
 * @param {number} offset - 0:å½“æœˆ, 1:ç¿Œæœˆ, -1:å‰æœˆâ€¦ãªã©
 * @returns {object} { year, month, firstWeekday, totalDays, numWeeks }
 **************************************************************************************/
function calcMonthInfo(offset) {
  const now = new Date();

  // (1) åŸºæº–ã¨ãªã‚‹å¹´æœˆã®1æ—¥ã‚’å–å¾—ï¼ˆä¾‹ï¼š2025/6/1 ãªã‚‰ offset=0, 2025/7/1ãªã‚‰ offset=1ï¼‰
  const baseDate = new Date(now.getFullYear(), now.getMonth() + offset, 1);
  const year  = baseDate.getFullYear();
  const month = baseDate.getMonth(); // 0-11

  // (2) ãã®æœˆã®1æ—¥ãŒä½•æ›œæ—¥ã‹ï¼ˆ0:æ—¥æ›œã€œ6:åœŸæ›œï¼‰
  const firstDay = new Date(year, month, 1);
  let firstWeekday = firstDay.getDay();

  // (3) æœˆæ›œå§‹ã¾ã‚Šã«èª¿æ•´ï¼ˆ0:æœˆ, 1:ç«...6:æ—¥ï¼‰
  firstWeekday = (firstWeekday === 0) ? 6 : firstWeekday - 1;

  // (4) ãã®æœˆã®æœ€çµ‚æ—¥ã¨æ—¥æ•°ã‚’å–å¾—
  const lastDay = new Date(year, month + 1, 0);
  const totalDays = lastDay.getDate();

  // (5) è¡¨ç¤ºä¸Šã®é€±æ•°ã‚’ç®—å‡º
  const numWeeks = Math.ceil((firstWeekday + totalDays) / 7);

  // (6) çµæœã‚’è¿”å´
  return { year, month, firstWeekday, totalDays, numWeeks };
}


/**************************************************************************************
 * ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚¯ãƒªãƒ‹ãƒƒã‚¯åï¼‹å¹´æœˆï¼‰ã‚’æ›´æ–°ã™ã‚‹
 * @param {number} year  - è¡¨ç¤ºä¸­ã®å¹´
 * @param {number} month - 0å§‹ã¾ã‚Šã®æœˆç•ªå·ï¼ˆè¡¨ç¤ºæ™‚ã¯+1ã™ã‚‹ï¼‰
 **************************************************************************************/
function updateTitle(year, month) {
  // #tableTitleè¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œã‚¯ãƒªãƒ‹ãƒƒã‚¯å å¹´æœˆ åŒ»å¸«å‹¤å‹™è¡¨ã€ã«ã‚»ãƒƒãƒˆ
  document.getElementById('tableTitle').textContent
    = `(é™¢å†…å‘ã‘)${clinicName} ${year}å¹´${month + 1}æœˆ åŒ»å¸«å‹¤å‹™è¡¨`;
}


/**************************************************************************************
 * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
 * ãƒ˜ãƒƒãƒ€ãƒ¼ã¨æœ¬æ–‡ï¼ˆtbodyï¼‰ã®ä¸¡æ–¹ã‚’ç©ºã«ã™ã‚‹
 **************************************************************************************/
function clearTable() {
  document.querySelector('#calendar thead').innerHTML = '';
  document.querySelector('#calendar tbody').innerHTML = '';
}


/**************************************************************************************
 * æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æç”»
 * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ä¸€ç•ªä¸Šã®è¡Œï¼ˆæ›œæ—¥è¦‹å‡ºã—ï¼‰ã‚’ç”Ÿæˆã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã‚‹
 **************************************************************************************/
function renderHeader() {
  const headRow = document.createElement('tr');
  
  // å·¦ç«¯ã®ç©ºç™½ã‚»ãƒ«ï¼ˆé€±ãƒ©ãƒ™ãƒ«ã®å ´æ‰€ç”¨ï¼‰
  headRow.appendChild(document.createElement('th'));

  // WEEKDAYSé…åˆ—ï¼ˆæœˆï½æ—¥ï¼‰ã‚’ä½¿ã£ã¦æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç”Ÿæˆ
  WEEKDAYS.forEach((wd, i) => {
    const th = document.createElement('th');
    th.textContent = wd;

    // åœŸæ›œãƒ»æ—¥æ›œã«è‰²ä»˜ã‘ç”¨ã‚¯ãƒ©ã‚¹ä»˜ä¸
    if (i === 5) th.classList.add('saturday'); // åœŸæ›œã¯6ç•ªç›®
    if (i === 6) th.classList.add('sunday');   // æ—¥æ›œã¯7ç•ªç›®
    headRow.appendChild(th);
  });

  // ãƒ†ãƒ¼ãƒ–ãƒ«ã®theadã«è¿½åŠ 
  document.querySelector('#calendar thead').appendChild(headRow);
}





/**************************************************************************************
 * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¦æç”»
 * @param {number} offset - ç¾åœ¨è¡¨ç¤ºã™ã‚‹æœˆã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆ0:ä»Šæœˆ, 1:ç¿Œæœˆ, ...ï¼‰
 **************************************************************************************/
function fetchSchedule(offset = 0) {
  // GASã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•° getScheduleData ã‚’å‘¼ã³å‡ºã—
  google.script.run
    .withFailureHandler(err => {
      // å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
      console.error('âŒ getScheduleData failed:', err);
    })
    .withSuccessHandler(data => {
      // ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—æ™‚ã¯ä½•ã‚‚ã—ãªã„
      if (!data) {
        console.error('âŒ getScheduleData returned null or undefined');
        return;
      }

      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€å°ãƒ»æœ€å¤§ã®å¹´æœˆï¼ˆYYYY-MMå½¢å¼ï¼‰ã‚’å—ã‘å–ã‚‹
      minYearMonth = data.minYearMonth;
      maxYearMonth = data.maxYearMonth;

      // ç¾åœ¨ã®å¹´æœˆï¼ˆYYYY-MMï¼‰ã‚’å®‰å…¨ã«ç®—å‡º
      const now = new Date();
      const base = new Date(now.getFullYear(), now.getMonth() + offset, 1); // â† Dateã§æ­£è¦åŒ–
      const thisYM = `${base.getFullYear()}-${String(base.getMonth() + 1).padStart(2, '0')}`;

      // å‰å¾Œæœˆãƒœã‚¿ãƒ³ã®æœ‰åŠ¹ãƒ»ç„¡åŠ¹
      document.getElementById('prevMonth').disabled = (thisYM <= minYearMonth);
      document.getElementById('nextMonth').disabled = (thisYM >= maxYearMonth);

      // ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¡¨ç¤º
      console.group('ğŸ“¡ Server debug');
      (data.debug||[]).forEach(line => console.log(line));
      console.groupEnd();

      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æ ¼ç´
      dates = Array.isArray(data.dates) ? data.dates : [];
      rooms = Array.isArray(data.rooms)
        ? data.rooms.sort((a, b) => {
            // éƒ¨ç½²ä¸¦ã³é †ã¯DEPT_ORDERã§åˆ¶å¾¡ã€‚æœªå®šç¾©ã¯å¾Œã‚
            const idxA = DEPT_ORDER.indexOf(a);
            const idxB = DEPT_ORDER.indexOf(b);
            if (idxA === -1 && idxB === -1) return a.localeCompare(b, 'ja');
            if (idxA === -1) return 1;
            if (idxB === -1) return -1;
            return idxA - idxB;
          })
        : [];
      schedule = data.schedule || {};
      holidays = Array.isArray(data.holidays) ? data.holidays : [];

      // å–å¾—å†…å®¹ã‚’ç¢ºèª
      console.log('âœ… getScheduleData OK:', { dates, rooms, schedule, holidays });

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
      renderCalendar(offset);
    })
    .getScheduleData(clinicCode, offset); // clinicCodeã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
}


// ç¾åœ¨ã®æœˆã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆä¾‹: 0=ä»Šæœˆ, 1=ç¿Œæœˆ, -1=å…ˆæœˆ ãªã©ï¼‰
let monthOffset = 0;

/**************************************************************************************
 * æŒ‡å®šã—ãŸã‚ªãƒ•ã‚»ãƒƒãƒˆã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹
 * @param {number} offset - æœˆã®ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤
 **************************************************************************************/
function reloadCalendar(offset) {
  monthOffset = offset;          // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
  fetchSchedule(monthOffset);    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»
}


// DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰åˆæœŸåŒ–å‡¦ç†
document.addEventListener('DOMContentLoaded', () => {
  monthOffset = 0;                 // åˆæœŸã¯ä»Šæœˆ
  reloadCalendar(monthOffset);     // æœ€åˆã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»

  // ã€Œâ—€ã€å‰æœˆãƒœã‚¿ãƒ³
  document.getElementById('prevMonth').addEventListener('click', () => {
    reloadCalendar(monthOffset - 1); // ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ãƒ‡ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¦å†æç”»
  });
  // ã€Œâ–¶ã€ç¿Œæœˆãƒœã‚¿ãƒ³
  document.getElementById('nextMonth').addEventListener('click', () => {
    reloadCalendar(monthOffset + 1); // ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¦å†æç”»
  });
});

// åŒ»å¸«åãªã©ã‚’æ‹¡å¤§è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
function showCellModal({ date, dept, time, name, tongue }) {
  const prevModal = document.querySelector('.cell-modal');
  if (prevModal) {
    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚’ä»˜ä¸
    prevModal.classList.add('fade-out');
    // å®Œå…¨ã«æ¶ˆãˆãŸã‚‰removeã—ã¦æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ä½œæˆ
    setTimeout(() => {
      prevModal.remove();
      createModal();  // æ–°è¦ãƒ¢ãƒ¼ãƒ€ãƒ«ç”Ÿæˆã‚’é–¢æ•°åŒ–
    }, 200); // CSSã®transitionã¨åŒã˜æ™‚é–“
  } else {
    createModal();
  }

  function createModal() {
    const modal = document.createElement('div');
    modal.className = 'cell-modal';
    modal.innerHTML = `
      <span class="close-btn" onclick="this.parentElement.remove()">Ã—</span>
      <div class="modal-label">æ—¥ä»˜</div>
      <div class="modal-value">${date}</div>
      <div class="modal-label">è¨ºç™‚ç§‘</div>
      <div class="modal-value">${dept}</div>
      <div class="modal-label">åŒ»å¸«å</div>
      <div class="modal-value">${name}${tongue ? ` <span title="èˆŒä¸‹">${tongue}</span>` : ""}</div>
      <div class="modal-label">å‹¤å‹™æ™‚é–“</div>
      <div class="modal-value">${time}</div>
    `;
    document.body.appendChild(modal);

    modal.addEventListener('click', e => {
      if (e.target === modal) modal.remove();
    });
  }
}


// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('cellModal').addEventListener('click', function(e) {
  if (e.target === this) this.style.display = 'none';
});

</script>
